
1. ZLMediaKit
	 ZLM默认不支持jtt1078协议.
	 通过git `https://gitee.com/zzhixinlove/zlmediakit-jt1078-a`上的jtt1078代码并且移植到最新的官方主分支上`#cb1821cf88170750dd7a2011c36717d9a7777fb1`编译通过
	 镜像为`zlmediakit-jtt1078/zlmediakit-jtt1078:Release.240823`

2. tuqiaoxing-media
	 此服务是现在使用的jtt1078流媒体服务.

### 相关验证
1. 使用ZLM与tqbb-media延迟差不多, 只是ZLM支持多种协议.
2. ZLM的jtt1078目前发现问题是flv和ts格式不支持非AAC的音频.
3. 测试验证大量请求tqbb-media服务,服务正常.(1万个线程模拟客户端访问直播流)
4. 测试验证大量设备上报数据(1万),请求时的瞬间cpu被打满, 当线程都启动成功后CPU降至70%,能正常操作与播放.
5. ZLM能很方便的接入各种推流, 很简单就能搭建一个视频通话程序.

**模拟设备并发请求代码:**

```java
public class Clients {

    @SneakyThrows
    
    private static Bootstrap create() {
    
        EventLoopGroup group = new NioEventLoopGroup();
        Bootstrap b = new Bootstrap();
        b.group(group).channel(NioSocketChannel.class)
            .option(ChannelOption.SO_KEEPALIVE, true)
            .handler(new ChannelInitializer<SocketChannel>() {

                @Override
                protected void initChannel(SocketChannel ch) throws Exception {
                    // skip
                }
            });
    
        return b;
    
    }
    
    @SneakyThrows
    
    public static void main(String[] args) {
        // String ip = "219.153.49.165";
        String ip = "127.0.0.1";
        int port = 27000;
        Bootstrap c = create();
        for (int i = 0; i < 10000; i ++) {
            ChannelFuture cf = c.connect(ip, port).sync();
            Channel ch = cf.channel();
            Thread.ofVirtual().start(() -> {
                try {
                    ChannelSet cs = ChannelSet.init();
                    cs.setCh(ch);
                    HT.run(cs); // 发送jtt1078的数据
                } catch (Exception e) {
                    e.printStackTrace();
                }
            });
        }
        System.out.println("started");
    }

}
```


**模拟客户端请求代码:**

```java
public class Client {
    static int idx = 0;
    static int max = 10000;
    final String LIVE = "http://localhost:3333/video/013800138999-2";
    public static void main(String[] args) throws Exception {
        CountDownLatch cdl = new CountDownLatch(max);
        IntStream.range(0, max).forEach(index -> {
            Thread.ofVirtual().start(() -> {
                System.out.println("start %s".formatted(index));
                try {
                    play();
                } catch (Exception e) {
                    if ("end then close.".equals(e.getMessage())) {
                        System.out.println("end %s".formatted(index));
                    } else {
                        e.printStackTrace();
                    }
                }
                cdl.countDown();
            });
        });
        cdl.await();
    }

    
    static void play() throws Exception {
        long st = System.currentTimeMillis();
        try (FileOutputStream out = new FileOutputStream(
                "./flv.dump.013306139148-2-%s.flv"
                .formatted(StringUtils.leftPad(idx ++ + "", 6, "0")))) {
            try (HttpClient hc = HttpClient.newBuilder().build()) {
            hc.send(HttpRequest.newBuilder()
                    .uri(URI.create(LIVE))
                    .GET()
                    .build(), 
                        HttpResponse
                        .BodyHandlers.ofByteArrayConsumer(data -> {
                        
                    data.ifPresent(t -> {
                        try {
                            out.write(t);
                        } catch (IOException e1) {
                        }
                    });
                    // 请求20秒的数据
                    if (TimeUnit
                        .MILLISECONDS
                        .toSeconds(System.currentTimeMillis() - st) >= 20) {
                        throw new RuntimeException("end then close.");
//                        System.out.println("shutdown!");
//                        hc.shutdownNow();
                    }
                }));
            }
        }
    }
}
```