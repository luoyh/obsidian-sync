### 3万设备模拟

**CPU和内存占用, 20G内存**
![[Pasted image 20240903150455.png]]


**3万设备正常**
![[Pasted image 20240903150519.png]]
![[Pasted image 20240903150536.png]]

**页面拉取流速度**
![[Pasted image 20240903150701.png]]


### 5万设备模拟

CPU占用, 内存20g
![[Pasted image 20240903152121.png]]


5万设备服务正常
![[Pasted image 20240903152141.png]]
![[Pasted image 20240903152154.png]]

前端拉流速度
![[Pasted image 20240903152215.png]]


### 压测代码

```java

@Slf4j
public class Clients {

    @SneakyThrows
    private static Bootstrap create() {
        EventLoopGroup group = new NioEventLoopGroup();
        Bootstrap b = new Bootstrap();
        b.group(group).channel(NioSocketChannel.class)
                .option(ChannelOption.SO_KEEPALIVE, true)
//                .option(ChannelOption.SO_REUSEADDR,true) //快速复用端口
                .option(ChannelOption.TCP_NODELAY, true)
                .handler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    protected void initChannel(SocketChannel ch) throws Exception {
                    }
                    
                });
        return b;
    }
    
    @SneakyThrows
    public static void main(String[] args) {
        String ip = args[0];
        int port = Integer.parseInt(args[1]);
        int size = Integer.parseInt(args[2]);
        // "E:\\.roy\\data\\.tmp\\tcpdump.bin"
        HT.init(args[3]);
        int startSIM = 0;
        if (args.length >= 5) {
            startSIM = Integer.parseInt(args[4]);
        }
        long sim = ChannelSet.startSIM(startSIM);
        log.info("start SIM with: {}", sim);
        
        Bootstrap c = create();
        for (int i = 0; i < size; i ++) {
            log.info(">>>>>>>>>>>>>> {}", i );
            start(c, ip, port, i);
        }
        log.info("started");
    }
    
    static void start(Bootstrap c, String ip, int port, int id) {
        try {
            c.connect(ip, port).addListener( (ChannelFutureListener) f -> {
                if (!f.isSuccess()) {
                    log.info("connect server fail");
                } else {
                    log.info("connect success: {}", id);
                    Thread.ofVirtual().start(() -> run(f.channel()));
                }
            }).get();
        } catch (Exception e) {
            log.error("error: {}", id, e);
        }
    }
    
    @SneakyThrows
    static void run(Channel ch) {
        ChannelSet cs = ChannelSet.init();
        cs.setCh(ch);
        HT.run(cs); // 发送报文
        ch.close();
    }
    
}

```